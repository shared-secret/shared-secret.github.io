<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Shared secret creation</title>
<style>
  body { font-size: 16px; color: white; background-color: #0C090A; }
  input, button, textarea { font-size: 12px; background-color: lightblue; }
  a { color: lightblue; }
</style>
<script src="nacl.min.js"></script>
<script src="nacl-util.min.js"></script>
<script>
  function setVal (id, val) { document.getElementById(id).value = val }
  
  function getVal (id) { return document.getElementById(id).value.trim() }
  
  function generate () {
    setVal('ss', '')
    try {
      const ss = nacl.box.before(nacl.util.decodeBase64(getVal('tpk')), nacl.util.decodeBase64(getVal('sk')))
      setVal('ss', nacl.util.encodeBase64(ss))
    } catch (err) { }
  }

 function encrypt () {
    const nonce = nacl.randomBytes(24)
    try {
      const text = getVal('text').trim()
      const encrypted = nacl.box.after(nacl.util.decodeUTF8(text), nonce, nacl.util.decodeBase64(getVal('ss')))
      const noncencrypted = new Uint8Array(24 + encrypted.length)
      noncencrypted.set(nonce)
      noncencrypted.set(encrypted, 24)
      setVal('code', nacl.util.encodeBase64(noncencrypted))
    } catch (err) { setVal('code', '') }
  }

  function decrypt () {
    try {
      const noncencrypted = nacl.util.decodeBase64(getVal('code').trim())
      const nonce = noncencrypted.subarray(0, 24)
      const encrypted = noncencrypted.subarray(24)
      const decrypted = nacl.box.open.after(encrypted, nonce, nacl.util.decodeBase64(getVal('ss')))
      setVal('text', nacl.util.encodeUTF8(decrypted))
    } catch (err) { setVal('text', '') }
  }
  
  function initSK () {
    const kp = nacl.box.keyPair()
    setVal('sk', nacl.util.encodeBase64(kp.secretKey))
    setVal('mpk', nacl.util.encodeBase64(kp.publicKey))
  }

  function copyText (id) {
    document.getElementById(id).select()
    document.execCommand('copy')
  }
</script>
</head>
<body onload="initSK()">
  <h3>Shared secret creation</h3>
  <input type="hidden" id="sk">
  <p>My public key:&nbsp;<input type="text" id="mpk" size="55" readonly>&nbsp;<button onclick="copyText('mpk')">Copy</button></p>
  <p>Their public key:&nbsp;<input type="text" id="tpk" size="55" oninput="generate()"></p>
  <p>Shared secret:&nbsp;<input type="text" id="ss" size="55" readonly>&nbsp;<button onclick="copyText('ss')">Copy</button></p>
  <h4>Instructions</h4>
  <ol>
  <li>A random <i>My public key</i> is generated every time this page is refreshed. It is read-only and in the base64 format.</li>
  <li>Send this key to another party which has their own instance of this page.</li>
  <li>Get their public key from them.</li>
  <li>Do not refresh this page while the public keys are being exchanged.</li>
  <li>Paste their public key into the designated field. The shared secret will appear if the key is valid.</li>
  <li>The other party must do the same on their end to view the shared secret.</li>
  </ol>
  <p>
  The shared secret can be used as a password to encrypt and decrypt a private message between you and the other party.
  For example, zip files (7zip is preferred) can be password encrypted and sent as email attachments.
  [Tip: send an encrypted message containing a shorter password for future use.]
  Short text messages can be encrypted/decrypted with the shared secret above using the boxes below.
  </p>
  <h3>Encryption</h3>
  <p>
  Text message to encrypt:<br><textarea id="text" rows="10" cols="100" oninput="encrypt()"></textarea>
  <br><button onclick="copyText('text')">Copy</button>
  </p>
  <p>
  Encrypted message:<br><textarea id="code" rows="10" cols="100" oninput="decrypt()"></textarea>
  <br><button onclick="copyText('code')">Copy</button>
  </p>
  <h4>Instructions</h4>
  <ol>
  <li>Create a shared secret at the top of this page.</li>
  <li>Type or paste a text message into the upper box.</li>
  <li>The encrypted message appears in the lower box as you type.</li>
  <li>Copy the encrypted message in the lower box and send it to the other party.</li>
  <li>When they receive it, they can paste it into their lower box.</li>
  <li>If they have the shared secret, the original (decrypted) message will appear in their upper box.</li>
  <li>They can reply to your message by following these instructions on their end.</li>
  </ol>
  <p><a href="https://github.com/shared-secret/shared-secret.github.io">Source code and security notes</a></p>
</body>
</html>
